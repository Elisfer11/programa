<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modo Competitivo</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f4f4;
      color: #000;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }
    h2 {
      text-align: center;
    }
    .top-bar {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      max-width: 400px;
      width: 100%;
    }
    #imagenTest {
      max-width: 350px;
      border-radius: 10px;
      margin: 10px 0;
    }
    .opciones button {
      margin: 5px 0;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background-color: #eee;
      cursor: pointer;
      transition: 0.3s;
    }
    .opciones button:hover {
      background-color: #ddd;
    }
    .incorrecto {
      background-color: #f44336 !important;
      color: white !important;
    }
    #resultado {
      font-size: 1.1em;
      margin-top: 15px;
      text-align: center;
    }
    #ranking {
      margin-top: 20px;
    }
    #ranking table {
      border-collapse: collapse;
      width: 100%;
      max-width: 400px;
    }
    #ranking th, #ranking td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    #ranking th {
      background-color: #00796b;
      color: white;
    }
    #botonReiniciar {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <script>
    const usuario = localStorage.getItem("usuario");
    if (!usuario || usuario.includes("Invitado")) {
      alert("Debes iniciar sesi√≥n para acceder al modo competitivo.");
      window.location.href = "/programa/index.html";
    }
  </script>

  <h2>Identifica el Elemento</h2>
  <div class="top-bar">
    <div id="vidas">Vidas: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <div id="tiempo">Tiempo: 0s</div>
    <div id="progreso">Progreso: 0/0</div>
  </div>
  <img id="imagenTest" src="" alt="Imagen de prueba" />
  <div id="infoTaxonomica"></div>
  <div id="preguntaTexto"></div>
  <div class="opciones" id="opciones"></div>
  <div id="resultado"></div>
  <div id="ranking"></div>
  <div id="botonReiniciar" style="display: none;">
    <button onclick="reiniciarJuego()">Volver a jugar</button>
  </div>

<script>
  const API_URL = 'https://quiz-backend-5lu1.onrender.com';
    const taxonomia = [
        {
            especie: "Rotaria citrina",
            imagen: "/programa/Lab4/imagenes/Filo_Rotifera-Clase_Hemirotatoria-subclase_Bdelloidea-Familia_Philodinidae-Rotaria_citrina.jpg",
            filo: "Rotifera",
            clase: "Hemirotatoria",
            subclase: "Bdelloidea",
            familia: "Philodinidae"
        },
        {
            especie: "Macracanthorhynchus hirudinaceus",
            imagen: "/programa/Lab4/imagenes/Filo_Rotifera-Clase_Hemirotatoria-subclase_Acanthocephala-Macracanthorhynchus_hirudinaceus.jpg",
            filo: "Rotifera",
            clase: "Hemirotatoria",
            subclase: "Acanthocephala"
        },
        {
            genero: "Brachionus",
            imagen: "/programa/Lab4/imagenes/Filo_Rotifera-Clase_Eurotatoria-Subclase_Monogonta-Familia_Brachionidae-Brachionus.jpg",
            filo: "Rotifera",
            clase: "Eurotatoria",
            subclase: "Monogonta",
            familia: "Brachionidae"
        },
        {
            genero: "Asplanchna",
            imagen: "/programa/Lab4/imagenes/Filo_Rotifera-Clase_Eurotatoria-Subclase_Monogonta-Familia_Asplanchnidae-Asplanchna.jpg",
            filo: "Rotifera",
            clase: "Eurotatoria",
            subclase: "Monogonta",
            familia: "Asplanchnidae"
        },
        {
            genero: "Plumatella",
            imagen: "/programa/Lab4/imagenes/Filo_Bryozoa-Phylactolaemata-Plumatella.jpg",
            filo: "Bryozoa",
            clase: "Phylactolaemata"
        },
        {
            genero: "Pectinatella",
            imagen: "/programa/Lab4/imagenes/Filo_Bryozoa-Phylactolaemata-Pectinatella.jpg",
            filo: "Bryozoa",
            clase: "Phylactolaemata"
        },
        {
            genero: "Bugula",
            imagen: "/programa/Lab4/imagenes/Filo_Bryozoa-Chelistomata-Bugula.jpg",
            filo: "Bryozoa",
            clase: "Chelistomata"
        },
        {
            genero: "Phoronopsis",
            imagen: "/programa/Lab4/imagenes/Filo_Phoronida-Familia_Phoronidae-Phoronopsis.jpg",
            filo: "Phoronida",
            familia: "Phoronidae"
        },
        {
            especie: "Glottidea audebartii",
            imagen: "/programa/Lab4/imagenes/Filo_Brachiopoda-Clase_Lingulata-Familia_Lingulidae-Glottidea_audebartii.jpg",
            filo: "Brachiopoda",
            clase: "Lingulata",
            familia: "Lingulidae"
        },
        {
            especie: "Discradisca strigata",
            imagen: "/programa/Lab4/imagenes/Filo_Brachiopoda-Clase_Lingulata-Familia_Discinidae-Discradisca_strigata.jpg",
            filo: "Brachiopoda",
            clase: "Lingulata",
            familia: "Discinidae"
        },
        {
            especie: "Terebratalia transversa",
            imagen: "/programa/Lab4/imagenes/Filo_Brachiopoda-Clase_Rhynchonollata-Terebratalia_transversa.jpg",
            filo: "Brachiopoda",
            clase: "Rhynchonollata"
        },
        {
            especie: "Laqueus californionus",
            imagen: "/programa/Lab4/imagenes/Filo_Brachiopoda-Clase_Rhynchonollata-Laqueus_californionus.jpg",
            filo: "Brachiopoda",
            clase: "Rhynchonollata"
        },
        {
            clase: "Heteronemertea",
            imagen: "/programa/Lab4/imagenes/Filo_Nemertea-Heteronemertea.jpg",
            filo: "Nemertea"
        },
        {
            clase: "Hoplonemertea",
            imagen: "/programa/Lab4/imagenes/Filo_Nemertea-Hoplonemertea.jpg",
            filo: "Nemertea"
        }
    ];

    let vidas = 3, tiempo = 0, totalPreguntas = 0, preguntasRespondidas = 0;
  let preguntasSeleccionadas = [], timer;

  function iniciarJuego() {
    preguntasSeleccionadas = [];
    const niveles = ["genero", "especie", "clase", "subclase", "familia", "filo"];
    let posibles = [];

    taxonomia.forEach(item => {
      const disponibles = niveles.filter(n => item[n]);
      const usados = new Set();
      while (usados.size < Math.min(2, disponibles.length)) {
        const nivel = disponibles[Math.floor(Math.random() * disponibles.length)];
        if (!usados.has(nivel)) {
          posibles.push({ item, nivel });
          usados.add(nivel);
        }
      }
    });

    while (posibles.length < 20) {
      const copia = posibles[Math.floor(Math.random() * posibles.length)];
      if (posibles.filter(p => p.item === copia.item).length < 2) {
        posibles.push(copia);
      }
    }

    preguntasSeleccionadas = posibles.sort(() => Math.random() - 0.5).slice(0, 20);
    totalPreguntas = preguntasSeleccionadas.length;
    preguntasRespondidas = 0;
    vidas = 3;
    tiempo = 0;

    actualizarVidas();
    actualizarProgreso();
    siguientePregunta();
    iniciarCronometro();
  }

  function actualizarVidas() {
    document.getElementById("vidas").innerText = "Vidas: " + "‚ù§Ô∏è".repeat(vidas);
  }

  function iniciarCronometro() {
    clearInterval(timer);
    timer = setInterval(() => {
      tiempo++;
      document.getElementById("tiempo").innerText = `Tiempo: ${tiempo}s`;
    }, 1000);
  }

  function siguientePregunta() {
    if (preguntasRespondidas >= totalPreguntas) {
      terminarJuego("üéâ ¬°Has completado el test!");
      return;
    }

    const { item: datos, nivel } = preguntasSeleccionadas[preguntasRespondidas];
    const correcta = datos[nivel];

    const opciones = new Set([correcta]);
    while (opciones.size < 4) {
      const aleatorio = taxonomia[Math.floor(Math.random() * taxonomia.length)];
      if (aleatorio[nivel]) opciones.add(aleatorio[nivel]);
    }

    const opcionesArray = Array.from(opciones).sort(() => Math.random() - 0.5);
    document.getElementById("imagenTest").src = datos.imagen;
    document.getElementById("preguntaTexto").innerText = `¬øCu√°l es ${nivel.toUpperCase()} de esta imagen?`;

    const info = [];
    if (nivel !== 'filo' && datos.filo) info.push(`Filo: ${datos.filo}`);
    if (nivel !== 'clase' && datos.clase) info.push(`Clase: ${datos.clase}`);
    if (nivel !== 'subclase' && datos.subclase) info.push(`Subclase: ${datos.subclase}`);
    if (nivel !== 'familia' && datos.familia) info.push(`Familia: ${datos.familia}`);
    if (nivel !== 'genero' && datos.genero) info.push(`G√©nero: ${datos.genero}`);
    if (nivel !== 'especie' && datos.especie) info.push(`Especie: ${datos.especie}`);
    document.getElementById("infoTaxonomica").innerHTML = info.map(i => `<span>${i}</span>`).join("");

    const contenedor = document.getElementById("opciones");
    contenedor.innerHTML = "";
    opcionesArray.forEach(op => {
      const btn = document.createElement("button");
      btn.innerText = op;
      btn.onclick = () => {
        if (!btn.classList.contains('incorrecto')) verificar(op, correcta, btn);
      };
      contenedor.appendChild(btn);
    });
  }

  function verificar(seleccion, correcto, boton) {
    const resultado = document.getElementById("resultado");
    if (seleccion === correcto) {
      resultado.innerText = "‚úîÔ∏è Correcto!";
      resultado.style.color = "green";
      preguntasRespondidas++;
      actualizarProgreso();
      setTimeout(siguientePregunta, 1000);
    } else {
      vidas--;
      tiempo += 3;
      actualizarVidas();
      resultado.innerText = "‚ùå Incorrecto. Intenta de nuevo.";
      resultado.style.color = "red";
      if (boton) boton.classList.add('incorrecto');
      if (vidas <= 0) terminarJuego("‚ò†Ô∏è Te has quedado sin vidas.");
    }
  }

  function actualizarProgreso() {
    document.getElementById("progreso").innerText = `Progreso: ${preguntasRespondidas}/${totalPreguntas}`;
  }

  async function terminarJuego(mensaje) {
    clearInterval(timer);
    const puntaje = Math.round((preguntasRespondidas * 1000) / (tiempo + 1));

    document.getElementById("imagenTest").style.display = "none";
    document.getElementById("opciones").innerHTML = "";
    document.getElementById("preguntaTexto").innerText = "";

    document.getElementById("resultado").innerHTML = `
      ${mensaje}<br>
      ‚è± Tiempo: ${tiempo}s<br>
      ‚úÖ Resultado: ${preguntasRespondidas}/${totalPreguntas}<br>
      üèÜ Puntaje final: <strong>${puntaje}</strong><br>
      Enviando puntaje...
    `;

    try {
      await fetch(`${API_URL}/api/puntajes`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: usuario, puntaje, tiempo })
      });

      const res = await fetch(`${API_URL}/api/puntajes/top10`);
      const ranking = await res.json();

      const puesto = ranking.findIndex(p => p.username === usuario && p.puntaje === puntaje) + 1;
      const rankingHTML = `
        <p>üìà Est√°s en el puesto <strong>${puesto > 0 ? puesto : "fuera del top 10"}</strong></p>
        <h3>üèÖ Top 10</h3>
        <table>
          <tr><th>Puesto</th><th>Usuario</th><th>Puntaje</th><th>Tiempo</th></tr>
          ${ranking.map((p, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${p.username}</td>
              <td>${p.puntaje}</td>
              <td>${p.tiempo}s</td>
            </tr>`).join("")}
        </table>`;
      document.getElementById("ranking").innerHTML = rankingHTML;
    } catch (err) {
      document.getElementById("ranking").innerText = "‚ö†Ô∏è Error al obtener el ranking.";
    }

    document.getElementById("botonReiniciar").style.display = "block";
  }

  function reiniciarJuego() {
    document.getElementById("imagenTest").style.display = "block";
    document.getElementById("ranking").innerHTML = "";
    document.getElementById("resultado").innerText = "";
    document.getElementById("botonReiniciar").style.display = "none";
    iniciarJuego();
  }

  iniciarJuego();
</script>
</body>
</html>

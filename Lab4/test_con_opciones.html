<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modo Competitivo</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom right, #e0f7fa, #ffffff);
      color: #333;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .container {
      background-color: white;
      margin: 30px 0;
      padding: 30px 20px;
      border-radius: 20px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      max-width: 600px;
      width: 90%;
      text-align: center;
    }

    h2 {
      font-size: 1.8rem;
      color: #00796b;
      margin-bottom: 15px;
    }

    .top-bar {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      font-size: 1.1em;
    }

    #imagenTest {
      width: 100%;
      max-width: 350px;
      border-radius: 10px;
      margin: 10px auto;
    }

    #infoTaxonomica {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
      margin: 10px 0;
    }

    #infoTaxonomica span {
      background: #e0f2f1;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9em;
    }

    #preguntaTexto {
      font-weight: bold;
      margin: 15px 0;
      font-size: 1.1em;
    }

    .opciones {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .opciones button {
      background-color: #f0f0f0;
      color: #333;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .opciones button:hover {
      background-color: #dcedc8;
    }

    .incorrecto {
      background-color: #f44336 !important;
      color: white !important;
    }

    #resultado {
      font-size: 1.1em;
      margin: 15px 0;
    }

    #ranking {
      margin-top: 20px;
    }

    #ranking table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
    }

    #ranking th, #ranking td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }

    #ranking th {
      background-color: #00796b;
      color: white;
    }

    #botonReiniciar {
      margin-top: 20px;
    }

    #botonReiniciar button {
      background-color: #00796b;
      color: white;
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #botonReiniciar button:hover {
      background-color: #004d40;
    }

    @media (max-width: 480px) {
      .container {
        padding: 20px;
      }

      .opciones button {
        font-size: 0.95rem;
        padding: 10px;
      }

      #ranking table {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Identifica el Elemento</h2>
    <div class="top-bar">
      <div id="vidas">Vidas: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      <div id="tiempo">Tiempo: 0s</div>
      <div id="progreso">Progreso: 0/0</div>
    </div>
    <img id="imagenTest" src="" alt="Imagen de prueba" />
    <div id="infoTaxonomica"></div>
    <div id="preguntaTexto"></div>
    <div class="opciones" id="opciones"></div>
    <div id="resultado"></div>
    <div id="ranking"></div>
    <div id="botonReiniciar" style="display: none;">
      <button onclick="reiniciarJuego()">Volver a jugar</button>
    </div>
  </div>

<script>
  const API_URL = 'https://quiz-backend-5lu1.onrender.com';
    const taxonomia = [
        {
            especie: "Rotaria citrina",
            imagen: "/programa/Lab4/imagenes/Filo_Rotifera-Clase_Hemirotatoria-subclase_Bdelloidea-Familia_Philodinidae-Rotaria_citrina.jpg",
            filo: "Rotifera",
            clase: "Hemirotatoria",
            subclase: "Bdelloidea",
            familia: "Philodinidae"
        },
        {
            especie: "Macracanthorhynchus hirudinaceus",
            imagen: "/programa/Lab4/imagenes/Filo_Rotifera-Clase_Hemirotatoria-subclase_Acanthocephala-Macracanthorhynchus_hirudinaceus.jpg",
            filo: "Rotifera",
            clase: "Hemirotatoria",
            subclase: "Acanthocephala"
        },
        {
            genero: "Brachionus",
            imagen: "/programa/Lab4/imagenes/Filo_Rotifera-Clase_Eurotatoria-Subclase_Monogonta-Familia_Brachionidae-Brachionus.jpg",
            filo: "Rotifera",
            clase: "Eurotatoria",
            subclase: "Monogonta",
            familia: "Brachionidae"
        },
        {
            genero: "Asplanchna",
            imagen: "/programa/Lab4/imagenes/Filo_Rotifera-Clase_Eurotatoria-Subclase_Monogonta-Familia_Asplanchnidae-Asplanchna.jpg",
            filo: "Rotifera",
            clase: "Eurotatoria",
            subclase: "Monogonta",
            familia: "Asplanchnidae"
        },
        {
            genero: "Plumatella",
            imagen: "/programa/Lab4/imagenes/Filo_Bryozoa-Phylactolaemata-Plumatella.jpg",
            filo: "Bryozoa",
            clase: "Phylactolaemata"
        },
        {
            genero: "Pectinatella",
            imagen: "/programa/Lab4/imagenes/Filo_Bryozoa-Phylactolaemata-Pectinatella.jpg",
            filo: "Bryozoa",
            clase: "Phylactolaemata"
        },
        {
            genero: "Bugula",
            imagen: "/programa/Lab4/imagenes/Filo_Bryozoa-Chelistomata-Bugula.jpg",
            filo: "Bryozoa",
            clase: "Chelistomata"
        },
        {
            genero: "Phoronopsis",
            imagen: "/programa/Lab4/imagenes/Filo_Phoronida-Familia_Phoronidae-Phoronopsis.jpg",
            filo: "Phoronida",
            familia: "Phoronidae"
        },
        {
            especie: "Glottidea audebartii",
            imagen: "/programa/Lab4/imagenes/Filo_Brachiopoda-Clase_Lingulata-Familia_Lingulidae-Glottidea_audebartii.jpg",
            filo: "Brachiopoda",
            clase: "Lingulata",
            familia: "Lingulidae"
        },
        {
            especie: "Discradisca strigata",
            imagen: "/programa/Lab4/imagenes/Filo_Brachiopoda-Clase_Lingulata-Familia_Discinidae-Discradisca_strigata.jpg",
            filo: "Brachiopoda",
            clase: "Lingulata",
            familia: "Discinidae"
        },
        {
            especie: "Terebratalia transversa",
            imagen: "/programa/Lab4/imagenes/Filo_Brachiopoda-Clase_Rhynchonollata-Terebratalia_transversa.jpg",
            filo: "Brachiopoda",
            clase: "Rhynchonollata"
        },
        {
            especie: "Laqueus californionus",
            imagen: "/programa/Lab4/imagenes/Filo_Brachiopoda-Clase_Rhynchonollata-Laqueus_californionus.jpg",
            filo: "Brachiopoda",
            clase: "Rhynchonollata"
        },
        {
            clase: "Heteronemertea",
            imagen: "/programa/Lab4/imagenes/Filo_Nemertea-Heteronemertea.jpg",
            filo: "Nemertea"
        },
        {
            clase: "Hoplonemertea",
            imagen: "/programa/Lab4/imagenes/Filo_Nemertea-Hoplonemertea.jpg",
            filo: "Nemertea"
        }
    ];

  let vidas = 3, tiempo = 0, totalPreguntas = 0, preguntasRespondidas = 0;
  let preguntasSeleccionadas = [], timer;

  function iniciarJuego() {
    preguntasSeleccionadas = [];
    const niveles = ["genero", "especie", "clase", "subclase", "familia", "filo"];
    let posibles = [];

    taxonomia.forEach(item => {
      const disponibles = niveles.filter(n => item[n]);
      const usados = new Set();
      while (usados.size < Math.min(2, disponibles.length)) {
        const nivel = disponibles[Math.floor(Math.random() * disponibles.length)];
        if (!usados.has(nivel)) {
          posibles.push({ item, nivel });
          usados.add(nivel);
        }
      }
    });

    while (posibles.length < 20) {
      const copia = posibles[Math.floor(Math.random() * posibles.length)];
      if (posibles.filter(p => p.item === copia.item).length < 2) {
        posibles.push(copia);
      }
    }

    preguntasSeleccionadas = posibles.sort(() => Math.random() - 0.5).slice(0, 20);
    totalPreguntas = preguntasSeleccionadas.length;
    preguntasRespondidas = 0;
    vidas = 3;
    tiempo = 0;

    actualizarVidas();
    actualizarProgreso();
    siguientePregunta();
    iniciarCronometro();
  }

  function actualizarVidas() {
    document.getElementById("vidas").innerText = "Vidas: " + "‚ù§Ô∏è".repeat(vidas);
  }

  function iniciarCronometro() {
    clearInterval(timer);
    timer = setInterval(() => {
      tiempo++;
      document.getElementById("tiempo").innerText = `Tiempo: ${tiempo}s`;
    }, 1000);
  }

  function siguientePregunta() {
    document.getElementById("resultado").innerText = "";
    if (preguntasRespondidas >= totalPreguntas) {
      terminarJuego("üéâ ¬°Has completado el test!");
      return;
    }

    const { item: datos, nivel } = preguntasSeleccionadas[preguntasRespondidas];
    const correcta = datos[nivel];

    const opciones = new Set([correcta]);
    while (opciones.size < 4) {
      const aleatorio = taxonomia[Math.floor(Math.random() * taxonomia.length)];
      if (aleatorio[nivel]) opciones.add(aleatorio[nivel]);
    }

    const opcionesArray = Array.from(opciones).sort(() => Math.random() - 0.5);
    document.getElementById("imagenTest").src = datos.imagen;
    document.getElementById("preguntaTexto").innerText = `¬øCu√°l es ${nivel.toUpperCase()} de esta imagen?`;

    const info = [];
    if (nivel !== 'filo' && datos.filo) info.push(`Filo: ${datos.filo}`);
    if (nivel !== 'clase' && datos.clase) info.push(`Clase: ${datos.clase}`);
    if (nivel !== 'subclase' && datos.subclase) info.push(`Subclase: ${datos.subclase}`);
    if (nivel !== 'familia' && datos.familia) info.push(`Familia: ${datos.familia}`);
    if (nivel !== 'genero' && datos.genero) info.push(`G√©nero: ${datos.genero}`);
    if (nivel !== 'especie' && datos.especie) info.push(`Especie: ${datos.especie}`);
    document.getElementById("infoTaxonomica").innerHTML = info.map(i => `<span>${i}</span>`).join("");

    const contenedor = document.getElementById("opciones");
    contenedor.innerHTML = "";
    opcionesArray.forEach(op => {
      const btn = document.createElement("button");
      btn.innerText = op;
      btn.onclick = () => {
        if (!btn.classList.contains('incorrecto')) verificar(op, correcta, btn);
      };
      contenedor.appendChild(btn);
    });
  }

  function verificar(seleccion, correcto, boton) {
    const resultado = document.getElementById("resultado");
    if (seleccion === correcto) {
      resultado.innerText = "‚úîÔ∏è Correcto!";
      resultado.style.color = "green";
      preguntasRespondidas++;
      actualizarProgreso();
      setTimeout(siguientePregunta, 1000);
    } else {
      vidas--;
      tiempo += 3;
      actualizarVidas();
      resultado.innerText = "‚ùå Incorrecto. Intenta de nuevo.";
      resultado.style.color = "red";
      if (boton) boton.classList.add('incorrecto');
      if (vidas <= 0) terminarJuego("‚ò†Ô∏è Te has quedado sin vidas.");
    }
  }

  function actualizarProgreso() {
    document.getElementById("progreso").innerText = `Progreso: ${preguntasRespondidas}/${totalPreguntas}`;
  }

  function terminarJuego(mensaje) {
    clearInterval(timer);
    const puntajeFinal = Math.round((preguntasRespondidas * 1000) / (tiempo + 1));
    const usuario = localStorage.getItem("usuario") || "undefined";

    document.getElementById("resultado").innerHTML = `
        ${mensaje}<br>
        ‚è± Tiempo: ${tiempo}s<br>
        ‚úÖ Resultado: ${preguntasRespondidas}/${totalPreguntas}<br>
        üèÜ Puntaje final: <strong>${puntajeFinal}</strong><br>
        <span id="estadoEnvio">Enviando puntaje...</span>
    `;

    document.getElementById("imagenTest").style.display = "none";
    document.getElementById("opciones").innerHTML = "";
    document.getElementById("preguntaTexto").innerText = "";

    fetch('https://quiz-backend-5lu1.onrender.com/api/puntajes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre: usuario, puntaje: puntajeFinal, tiempo: `${tiempo}s` })
    })
    .then(() => {
        document.getElementById("estadoEnvio").innerText = "‚úÖ Puntaje guardado";
        mostrarRanking(puntajeFinal, usuario);
    })
    .catch(() => {
        document.getElementById("estadoEnvio").innerText = "‚ùå Error al guardar puntaje";
    });

    document.getElementById("botonReiniciar").style.display = "block";
}

function mostrarRanking(puntajeUsuario, nombreUsuario) {
    fetch('https://quiz-backend-5lu1.onrender.com/api/puntajes')
    .then(res => res.json())
    .then(data => {
        const tabla = document.createElement("table");
        tabla.style.margin = "20px auto";
        tabla.style.borderCollapse = "collapse";

        tabla.innerHTML = `
            <tr><th>Puesto</th><th>Usuario</th><th>Puntaje</th><th>Tiempo</th></tr>
            ${data.map((p, i) => `
              <tr>
                <td>${i + 1}</td>
                <td>${p.nombre}</td>
                <td>${p.puntaje}</td>
                <td>${p.tiempo}</td>
              </tr>
            `).join("")}
        `;
        tabla.querySelectorAll("th, td").forEach(cell => {
            cell.style.border = "1px solid #888";
            cell.style.padding = "4px 8px";
        });

        const posicion = data.findIndex(p => p.nombre === nombreUsuario);
        const mensajePosicion = posicion >= 0
          ? `üìà Est√°s en el puesto <strong>${posicion + 1}</strong>`
          : "üìâ Est√°s fuera del top 10";

        document.getElementById("resultado").innerHTML += `
          <p>${mensajePosicion}</p>
          <h3>üèÖ Top 10</h3>
        `;
        document.getElementById("resultado").appendChild(tabla);
    });
}

function reiniciarJuego() {
    document.getElementById("botonReiniciar").style.display = "none";
    document.getElementById("imagenTest").style.display = "block";
    document.getElementById("ranking").innerHTML = "";
    iniciarJuego();
}
  iniciarJuego();
</script>
</body>
</html>
